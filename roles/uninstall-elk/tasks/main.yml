---
# tasks file for roles/remove
- name: Disable service before remove
  shell: if systemctl is-enabled --quiet {{ item }}; then systemctl disable {{ item }} && echo disable_ok ; fi
  register: output
  changed_when: "'disable_ok' in output.stdout"
  loop:
    - elasticsearch
    - kibana
    - metricbeat
    - filebeat
    - logstash
    - nginx
    - heartbeat-elastic
      
- name: Purge ELK packages
  shell: "sudo apt purge --remove -y elasticsearch kibana logstash metricbeat filebeat nginx nginx-full nginx-common heartbeat-elastic"
  ignore_errors: yes

- name: autoremove package
  shell: "sudo apt autoremove -y"

- name: "Delete ELK directories"
  become: true
  shell: "rm -rf /usr/share/{{ item }}/ /etc/{{ item }}/ /var/lib/{{ item }}/ /var/log/{{ item }}/"
  loop:
    - filebeat
    - elasticsearch
    - logstash
    - kibana
    - metricbeat
    - logstash
    - kibana
    - elasticsearch
    - filebeat
    - kibana
    - logstash
    - filebeat
    - metricbeat
    - nginx
    - heartbeat

- name: remove pgp
  shell: "sudo rm -rf /usr/share/keyrings/elasticsearch-keyring.gpg"

- name: remove source
  shell: "sudo rm -rf /etc/apt/sources.list.d/elastic-8.x.list"
  
- name: update package
  shell: "sudo apt -y autoremove"

- name: update package
  shell: "sudo apt-get update"
